#!/usr/bin/python3

from sys import argv, exit, stderr
import argparse
from glob import iglob
from os.path import isfile, isdir
from swidq import SWIDTag

parser = argparse.ArgumentParser(description='List SWID tags.')
parser.add_argument('--debug', action='store_true', help="verbose debugging messages")
parser.add_argument('files', type=str, nargs='+', help='files to process')
opts = parser.parse_args()

exit_status = 0

def load_file(f):
	if opts.debug:
		stderr.write("%s: parsing [%s]\n" % (argv[0], f))
	tag = SWIDTag(f)
	errors = tag.get_errors()
	if errors is not None:
		for e in errors:
			stderr.write("%s: %s\n" % (argv[0], e))
		return

	if opts.debug:
		stderr.write("%s: %s\n" % (argv[0], tag.get_info()))
	print("%s %s" % (tag.get_tagid(), tag.get_path()))

for f in opts.files:
	if isfile(f) or f == '-':
		load_file(f)
	else:
		fg = sorted(iglob(f))
		if not fg:
			stderr.write("%s: no file matching [%s]\n" % (argv[0], f))
			exit_status = 1
		for g in fg:
			if isdir(g):
				for gg in sorted(iglob(g + "/*.swidtag")):
					load_file(gg)
			else:
				load_file(g)

if opts.debug:
	stderr.write("%s: exitting.\n" % argv[0])

exit(exit_status)
